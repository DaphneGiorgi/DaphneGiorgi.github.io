<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IBMPopSim package description • IBMPopSim</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="IBMPopSim package description">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">IBMPopSim</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/IBMPopSim.html">Package description</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/IBMPopSim_cpp.html">C++ essentials</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/IBMPopSim_human_pop.html">Human population</a>
    </li>
    <li>
      <a href="../articles/IBMPopSim_human_pop_IMD.html">Human population with swap</a>
    </li>
    <li>
      <a href="../articles/IBMPopSim_insurance_portfolio.html">Insurance portfolio</a>
    </li>
    <li>
      <a href="../articles/IBMPopSim_interaction.html">Population with genetically variable traits</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/daphnegiorgi/IBMPopSim/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>IBMPopSim package description</h1>
                        <h4 data-toc-skip class="author">Daphné Giorgi, Sarah Kaakai, Vincent Lemaire</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DaphneGiorgi/IBMPopSim/blob/HEAD/vignettes/IBMPopSim.Rmd" class="external-link"><code>vignettes/IBMPopSim.Rmd</code></a></small>
      <div class="hidden name"><code>IBMPopSim.Rmd</code></div>

    </div>

    
    
<p>The R package <code>IBMPopSim</code> aims at simulatimg the random evolution of heterogeneous populations, called stochastic Individual-Based Models (IBMs), or agent-based models.
The package enables users to simulate population evolution, in which individuals are characterized by their age and some characteristics, and the population is modified by different types of events, including births/arrivals, death/exit events, or changes of characteristics. The frequency at which an event can occur to an individual can depend on their age and characteristics, but also on the characteristics of other individuals (interactions).
Such models have a wide range of applications in fields including actuarial science, biology, ecology or epidemiology.</p>
<p><code>IBMPopSim</code> overcomes the limitations of time-consuming IBMs simulations by implementing new efficient algorithms based on thinning methods, which are compiled using the <code>Rcpp</code> package while providing a user friendly interface.</p>
<p>For a detailed description of the theoretical framework behind IBMs that can be implement in <code>IBMPopSim</code>, we refer to <span class="citation">(Giorgi, Kaakai, and Lemaire 2023)</span>. We provide below the main guidelines for the understanding and implementing stochastic population evolution with <code>IBMPopSim</code>.</p>
<div class="section level2" number="1">
<h2 id="brief-overview-of-individual-based-models-ibms">
<span class="header-section-number">1</span> Brief overview of Individual-Based-Models (IBMs)<a class="anchor" aria-label="anchor" href="#brief-overview-of-individual-based-models-ibms"></a>
</h2>
<p>Stochastic Individual-Based Models (IBMs) represent a broad class of random population dynamics models, allowing the description of population evolution on a microscopic scale.
Informally, an IBM can be summarized by the description of the individuals constituting the population, the various types of events that can occur to these individuals, along with their respective frequencies.</p>
<p>Let us start with a brief description of the class of IBMs that can be simulated using <code>IBMPopSim</code>.</p>
<div class="section level3" number="1.1">
<h3 id="Pop">
<span class="header-section-number">1.1</span> Individuals and population<a class="anchor" aria-label="anchor" href="#Pop"></a>
</h3>
<p>First, individuals can be characterized by their age and/or a collection of discrete or continuous characteristics (position, subgroup, size, habits, …). Formally, an individual is represented by a triplet <span class="math inline">\(I = (\tau^b, \tau^d, x)\)</span> with:</p>
<ul>
<li>
<span class="math inline">\(\tau^b \in \mathbb R\)</span> the date of birth, or <span class="math inline">\(a(t) =t-\tau^b\)</span> the age of the individual at time <span class="math inline">\(t\)</span>.</li>
<li>
<span class="math inline">\(\tau^d \in \bar{\mathbb R}\)</span> the death date, with <span class="math inline">\(\tau^d = \infty\)</span> if the individual is still alive,</li>
<li>a vector <span class="math inline">\(x\)</span> of characteristics.</li>
</ul>
<p>The population at a given time <span class="math inline">\(t\)</span> is the set
<span class="math display">\[Z_t=\{ I_k  ; \; k= 1,\dots, N_t\},\]</span>
composed of all individuals (alive or dead) who have lived in the population before time <span class="math inline">\(t\)</span>.</p>
</div>
<div class="section level3" number="1.2">
<h3 id="eventsTh">
<span class="header-section-number">1.2</span> Events type<a class="anchor" aria-label="anchor" href="#eventsTh"></a>
</h3>
<p>The package enables users to simulate populations where one or more of the five following event types may occur:</p>
<ul>
<li>
<strong>Birth event</strong>: addition of an individual of age 0 to the population.</li>
<li>
<strong>Death event</strong>: removal of an individual from the population.</li>
<li>
<strong>Entry event</strong>: arrival of an individual in the population.</li>
<li>
<strong>Exit (emigration) event</strong>: exit from the population (other than death).</li>
<li>
<strong>Swap event</strong>: an individual changes of characteristics.</li>
</ul>
<p>With each event type is associated an <strong>event kernel</strong>, describing how the population is modified following the occurrence of the event. For some event types, the event kernel requires explicit specification. For example, in the case of a new individual entering the population (entry event), the model must define how the age and characteristics of this new individual are chosen. For instance, the characteristics of a new individual in the population can be chosen uniformly in the space of all characteristics, or can depend on the distribution of his parents or those of the other individuals composing the population.</p>
</div>
<div class="section level3" number="1.3">
<h3 id="Eventintensityth">
<span class="header-section-number">1.3</span> Intensity classes<a class="anchor" aria-label="anchor" href="#Eventintensityth"></a>
</h3>
<p>Finally, once the different types of events have been defined, it remains to describe how frequently the events can occur in the population.</p>
<p>Informally, an event intensity is a function <span class="math inline">\(\lambda^e_t(I, Z_t)\)</span> describing the frequency at which an event <span class="math inline">\(e\)</span> can occur to <em>an individual</em> <span class="math inline">\(I\)</span>, living in a population <span class="math inline">\(Z_t\)</span> at a time <span class="math inline">\(t\)</span>. Given a history of the population <span class="math inline">\((\mathcal{F}_t)\)</span>, the probability of event <span class="math inline">\(e\)</span> occurring to individual <span class="math inline">\(I\)</span> during a small interval of time <span class="math inline">\((t,t+dt]\)</span> is proportional to <span class="math inline">\(\lambda^e(I,t)\)</span>:</p>
<p><span class="math display">\[\begin{equation}
  \mathbb{P}(\text{event } e \text{ occurring to $I$ during } (t,t+dt] | \mathcal{F}_t) \simeq \lambda^e_t(I, Z_t)dt.
\end{equation}\]</span></p>
<p>The intensity function <span class="math inline">\(\lambda^e\)</span> can include dependency on the individual’s <span class="math inline">\(I\)</span> age <span class="math inline">\(a(t)\)</span> and characteristics <span class="math inline">\(x\)</span>, the time <span class="math inline">\(t\)</span>, or the population composition <span class="math inline">\(Z\)</span>. The dependence of <span class="math inline">\(\lambda^e\)</span> on the population <span class="math inline">\(Z\)</span> models interactions between individuals in the populations.
Hence, two types of intensity functions can be implemented in IBMPopSim:</p>
<ol style="list-style-type: decimal">
<li><p><em>No interactions (individual intensity):</em> The intensity function <span class="math inline">\(\lambda^e\)</span> does not depend on the population composition. The intensity at which the event of type <span class="math inline">\(e\)</span> occur to an individual <span class="math inline">\(I\)</span> only depends on its date of birth and characteristics:
<span class="math display" id="eq:intensityNointeraction">\[\begin{equation}
\tag{1.1}
\lambda^e_t (I,Z_t) = \lambda^e(t, I),
\end{equation}\]</span>
where <span class="math inline">\(\lambda^e: \mathbb{R}_+ \times \mathcal{I} \to \mathbb{R}^+\)</span> is a deterministic function.</p></li>
<li><p><em>``Quadratic’’ interactions:</em> The intensity at which an event of type <span class="math inline">\(e\)</span> occur to an individual <span class="math inline">\(I\)</span> depends on <span class="math inline">\(I\)</span> and on the population composition, through an interaction function <span class="math inline">\(W^e\)</span>. The quantity <span class="math inline">\(W^e(t, I,J)\)</span> describes the intensity of interactions between two alive individuals <span class="math inline">\(I\)</span> and <span class="math inline">\(J\)</span> at time <span class="math inline">\(t\)</span>, for instance in the presence of competition or cooperation. In this case, we have
<span class="math display" id="eq:intensityInteraction">\[\begin{equation}
\tag{1.2}
\lambda^e_t(I,Z_t)=\sum_{j \in Z_t} W^e(t, I, J).
\end{equation}\]</span></p></li>
</ol>
<p>See the <code><a href="../articles/IBMPopSim_interaction.html">vignette('IBMPopSim_interaction')</a></code> for an example of intensity with interaction (associated with the death event) and without interactions (associated with the birth event).</p>
<p><strong>Events intensity bounds</strong> In order to simulate the population evolution by thinning for the various events intensities <span class="math inline">\(\lambda^e_t(I,Z_t)\)</span>:</p>
<ol style="list-style-type: decimal">
<li><p><em>No interactions (individual intensity):</em> The individual event intensity <span class="math inline">\(\lambda^e\)</span> with no interactions, as defined in <a href="#eq:intensityNointeraction">(1.1)</a>, is assumed to be uniformly bounded:
<span class="math display" id="eq:boundlambda">\[\begin{equation}
\tag{1.3}
\lambda^e(t, I) \leq \bar \lambda^e.
\end{equation}\]</span></p></li>
<li><p><em>``Quadratic’’ interactions:</em> The interaction function <span class="math inline">\(W^e\)</span>, as defined in <a href="#eq:intensityInteraction">(1.2)</a>, is assumed to be uniformly bounded:
<span class="math display" id="eq:boundW">\[\begin{equation}
\tag{1.4}
W^e(t, I, J) \leq \bar W^e.
\end{equation}\]</span></p></li>
</ol>
<p>In <code>IBMPopSim</code>, events can also occur in the population with a global intensity of Poisson type <span class="math inline">\((\mu^e_t)_{t \geq 0 }\)</span>, which does not depend on individuals or the population composition, and assumed to be bounded by a constant <span class="math inline">\(\bar \mu^e\)</span>. This can be the case for instance when we model arrivals in the population at a constant rate.</p>
</div>
<div class="section level3" number="1.4">
<h3 id="algo">
<span class="header-section-number">1.4</span> Simulation algorithm<a class="anchor" aria-label="anchor" href="#algo"></a>
</h3>
<p>The IBM simulation algorithm is based on an acceptance-rejection method for simulating random times called <strong>thinning</strong>, described in details in <span class="citation">(Giorgi, Kaakai, and Lemaire 2023)</span>, and generalizing the algorithm proposed by <span class="citation">(Fournier and Méléard 2004)</span> (see also <span class="citation">(Ferrière and Tran 2009)</span>, <span class="citation">(Boumezoued 2016)</span>).</p>
<p>The algorithm is based on exponential ``candidate” event times. Starting from time <span class="math inline">\(t\)</span>, once a candidate event time <span class="math inline">\(t + \bar T_\ell\)</span> has been proposed, a candidate event type <span class="math inline">\(e\)</span> (birth, death,…) is chosen with a probability <span class="math inline">\(p^e\)</span> depending on the event intensity bounds <span class="math inline">\(\bar \lambda^e\)</span> and <span class="math inline">\(\bar W^e\)</span>. A individual <span class="math inline">\(I\)</span> is then drawn from the population. Finally, it remains to accept or reject the candidate event with a probability <span class="math inline">\(q^e(t,I,Z_t)\)</span> depending on the true event intensity. If the candidate event time is accepted, then the event <span class="math inline">\(e\)</span> occurs at time <span class="math inline">\(t + \bar T_\ell\)</span> to the individual <span class="math inline">\(I\)</span>. The main steps of the algorithm can be summarized as follows:</p>
<ol style="list-style-type: decimal">
<li>Draw a candidate time <span class="math inline">\(t + \bar T_\ell\)</span> and candidate event type <span class="math inline">\(e\)</span>.</li>
<li>Draw a uniform variable <span class="math inline">\(\theta \sim \mathcal{U}([0, 1])\)</span> and individual <span class="math inline">\(I\)</span>.</li>
<li>
<strong>If</strong> <span class="math inline">\(\theta \leq q^e(t,I,Z_t)\)</span> <strong>then</strong> event <span class="math inline">\(e\)</span> occur to individual <span class="math inline">\(I\)</span>, <strong>else</strong> Do nothing and start again from <span class="math inline">\(t + \bar T_\ell\)</span>.</li>
</ol>
</div>
</div>
<div class="section level2" number="2">
<h2 id="package-description">
<span class="header-section-number">2</span> Package description<a class="anchor" aria-label="anchor" href="#package-description"></a>
</h2>
<p>We can now detail the construction and simulation of an IBM using the package.
The implementation of an IBM model is based on a few building blocks, easy to manipulate. For code efficiency, the user shall write a few lines of C++ code to define events intensity and kernel. This code is concatenated with internal code in the package and the result is compiled internally using the <code>Rcpp</code> package. The produced model is usually very fast and can be multithreaded. Furthermore, the parameters of the model can be modified from a call to another without having to recompile the code.</p>
<div class="section level3" number="2.1">
<h3 id="installation">
<span class="header-section-number">2.1</span> Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>The latest stable version can be installed from CRAN:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'IBMPopSim'</span><span class="op">)</span></span></code></pre></div>
<p>The latest development version can be installed from github:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">'DaphneGiorgi/IBMPopSim'</span><span class="op">)</span></span></code></pre></div>
<p><strong><em>First example to check installation</em></strong></p>
<p>To illustrate the use of the package and to check the installation, a simple model with Poisson arrivals and exits is implemented. Starting from an initial population <code>pop</code>, we define two events <code>birth</code> and <code>death</code> with intensity of Poisson type, we create the model <code>birth_death</code> and simulate the population evolution over 10 years.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/daphnegiorgi/IBMPopSim" class="external-link">IBMPopSim</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">init_size</span> <span class="op">&lt;-</span> <span class="fl">100000</span></span>
<span><span class="va">pop_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>birth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">init_size</span><span class="op">)</span>, death <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">birth</span> <span class="op">=</span> <span class="fu"><a href="../reference/mk_event_poisson.html">mk_event_poisson</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'birth'</span>, intensity <span class="op">=</span> <span class="st">'lambda'</span><span class="op">)</span></span>
<span><span class="va">death</span> <span class="op">=</span> <span class="fu"><a href="../reference/mk_event_poisson.html">mk_event_poisson</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'death'</span>, intensity <span class="op">=</span> <span class="st">'mu'</span><span class="op">)</span></span>
<span><span class="va">params</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'lambda'</span> <span class="op">=</span> <span class="fl">100</span>, <span class="st">'mu'</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mk_model compiles C++ code using sourceCpp from Rcpp</span></span>
<span><span class="va">birth_death</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_model.html">mk_model</a></span><span class="op">(</span>characteristics <span class="op">=</span> <span class="fu"><a href="../reference/get_characteristics.html">get_characteristics</a></span><span class="op">(</span><span class="va">pop_init</span><span class="op">)</span>,</span>
<span>                        events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">birth</span>, <span class="va">death</span><span class="op">)</span>,</span>
<span>                        parameters <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">birth_death</span>, </span>
<span>                  initial_population <span class="op">=</span> <span class="va">pop_init</span>, </span>
<span>                  events_bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'birth'</span> <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">lambda</span>, <span class="st">'death'</span> <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">mu</span><span class="op">)</span>,</span>
<span>                  parameters <span class="op">=</span> <span class="va">params</span>, </span>
<span>                  time <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">num_births</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sim_out</span><span class="op">$</span><span class="va">population</span><span class="op">$</span><span class="va">birth</span><span class="op">)</span> <span class="op">-</span> <span class="va">init_size</span></span>
<span><span class="va">num_deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">sim_out</span><span class="op">$</span><span class="va">population</span><span class="op">$</span><span class="va">death</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"births"</span> <span class="op">=</span> <span class="va">num_births</span>, <span class="st">"deaths"</span> <span class="op">=</span> <span class="va">num_deaths</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## births deaths </span></span>
<span><span class="co">##    967   1064</span></span></code></pre></div>
<p>Let’s now take a closer look at each component of a model in <code>IBMPopSim</code>, starting from the population.</p>
</div>
<div class="section level3" number="2.2">
<h3 id="population">
<span class="header-section-number">2.2</span> Population<a class="anchor" aria-label="anchor" href="#population"></a>
</h3>
<p>A population <span class="math inline">\(Z_t\)</span> is represented by an object of class <code><a href="../reference/population.html">?population</a></code> containing a data frame where each row corresponds to an individual <span class="math inline">\(I=(\tau^b, \tau^d, x)\)</span>, and which has at least two columns, <code>birth</code> and <code>death</code>, corresponding to the birth date <span class="math inline">\(\tau^b\)</span> and death/exit date <span class="math inline">\(\tau^d\)</span> (<span class="math inline">\(\tau^d\)</span> is set to <code>NA</code> for alive individuals). The population can contain more than two columns if individuals are described by multiple characteristics <span class="math inline">\(x= (x_1,\dots x_n)\)</span>.</p>
<p><strong>Type of a characteristic</strong> A characteristic <span class="math inline">\(x_i\)</span> must be of atomic type: logical (<code>bool</code> in <code>C++</code>), integer (<code>int</code>), double (<code>double</code>) or character (<code>char</code>). The function <code><a href="../reference/get_characteristics.html">?get_characteristics</a></code> allows to easily get the characteristics names and their types (both in <code>R</code> and <code>C++</code>) from a <code><a href="../reference/population.html">?population</a></code>. We draw the attention to the fact that some names for characteristics are reserved to specific cases : this is the case for <code>birth, death, entry, out, id</code>.</p>
<p><strong>Entry and exit events</strong> If <strong>entry events</strong> can occur in the population, the population shall contain a characteristic named <code>entry</code>. This can be done by setting the flag <code>entry=TRUE</code> in the <code><a href="../reference/population.html">?population</a></code> function, or by calling the <code><a href="../reference/add_characteristic.html">?add_characteristic</a></code> function on an existing population. During the simulation, the date at which an individual enters the population is automatically recorded in the variable <code>I.entry</code>.
If <strong>exit events</strong> can occur, the population shall contain a characteristic named <code>out</code>. This can be done by setting the flag <code>out=TRUE</code> in the <code><a href="../reference/population.html">?population</a></code> function, or by calling the <code><a href="../reference/add_characteristic.html">?add_characteristic</a></code> function. When an individual <code>I</code> exits the population during the simulation, <code>I.out</code> is set to <code>TRUE</code> and its exit time is recorded as a ``death’’ date.</p>
<p>In the example below, individuals are described by their birth and death dates, as well a Boolean characteristics called male, and the <code>entry</code> characteristic. For instance, the first individual is a female whose age at <span class="math inline">\(t_0=0\)</span> is <span class="math inline">\(107\)</span> and who was originally in the population.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="va">EW_pop_14</span><span class="op">$</span><span class="va">sample</span>,entry<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">pop_init</span><span class="op">)</span></span>
<span><span class="co">## Classes 'population' and 'data.frame':   100000 obs. of  4 variables:</span></span>
<span><span class="co">##  $ birth: num  -107 -107 -105 -104 -104 ...</span></span>
<span><span class="co">##  $ death: num  NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ male : logi  FALSE FALSE TRUE FALSE FALSE FALSE ...</span></span>
<span><span class="co">##  $ entry: logi  NA NA NA NA NA NA ...</span></span></code></pre></div>
<p><strong>Individual</strong> In the <code>C++</code> compiled model, an individual <code>I</code> is an object of an internal class containing some attributes (<code>birth_date</code>, <code>death_date</code> and the characteristics, here <code>male</code>), and some methods:</p>
<ul>
<li>
<code>I.age(t)</code>: a <code>const</code> method returning the age of an individual <code>I</code> at time <code>t</code>,</li>
<li>
<code>I.set_age(a, t)</code>: a method to set the age <code>a</code> at time <code>t</code> of an individual <code>I</code> (set <code>birth_date</code> at <code>t-a</code>),</li>
<li>
<code>I.is_dead(t)</code>: a <code>const</code> method returning <code>true</code> if the individual <code>I</code> is dead at time <code>t</code>.</li>
</ul>
</div>
<div class="section level3" number="2.3">
<h3 id="events">
<span class="header-section-number">2.3</span> Events<a class="anchor" aria-label="anchor" href="#events"></a>
</h3>
<p>The most important step of the model creation is the events creation. The call to the function creating an event is of form</p>
<pre><code><span><span class="fu">mk_event_CLASS</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"TYPE"</span>, name <span class="op">=</span><span class="st">"NAME"</span>, <span class="va">...</span><span class="op">)</span></span></code></pre>
<p>where <code>CLASS</code> is replaced by the class of the event intensity, as described in Section <a href="#Eventintensityth">1.3</a> and <code>type</code> corresponds to the event type of Section <a href="#eventsTh">1.2</a>. They are summarized in the below.
The other arguments depend on the intensity class and on the event type.</p>
<table class="table">
<caption>Event types</caption>
<thead><tr class="header">
<th align="left">Event type</th>
<th align="left"><code>Type</code></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Birth</td>
<td align="left"><code>birth</code></td>
</tr>
<tr class="even">
<td align="left">Entry</td>
<td align="left"><code>entry</code></td>
</tr>
<tr class="odd">
<td align="left">Death</td>
<td align="left"><code>death</code></td>
</tr>
<tr class="even">
<td align="left">Exit</td>
<td align="left"><code>exit</code></td>
</tr>
<tr class="odd">
<td align="left">Swap</td>
<td align="left"><code>swap</code></td>
</tr>
<tr class="even">
<td align="left">Custom</td>
<td align="left"><code>custom</code></td>
</tr>
</tbody>
</table>
<table class="table">
<caption>Intensity classes</caption>
<thead><tr class="header">
<th align="left">Intensity class</th>
<th align="left"><code>Class</code></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Poisson</td>
<td align="left"><code>poisson</code></td>
</tr>
<tr class="even">
<td align="left">Inhomogeneous Poisson</td>
<td align="left"><code>inhomogeneous_poisson</code></td>
</tr>
<tr class="odd">
<td align="left">Individual</td>
<td align="left"><code>individual</code></td>
</tr>
<tr class="even">
<td align="left">Interaction</td>
<td align="left"><code>interaction</code></td>
</tr>
</tbody>
</table>
<p>The intensity function and the kernel of an event are defined through
arguments of the function <code>mk_event_CLASS</code>. These arguments are
strings composed of few lines of code defining the frequency of the event and
the action of the event on individuals. Since the model is compiled
using <code>Rcpp</code>, the code should be written in <code>C++</code>. However, thanks to the
model parameters and functions/variables of the package, even the
non-experienced <code>C++</code> user can define a model quite easily. Several
examples are given in the vignettes of this package, and basic
<code>C++</code> tools are presented in the <code><a href="../articles/IBMPopSim_cpp.html">vignette('IBMPopSim_cpp')</a></code>.</p>
<p>The optional argument <code>name</code> gives a name to the event. If not
specified, the name of the event is its type, for instance
<code>death</code>. However, a name must be specified if the model is
composed of several events with the same type.</p>
<p><strong>Parameters</strong> In order to facilitate the implementation, the user can defined a list of model parameters, stored in a named list. The parameters can be of
atomic type, numeric vector or matrix,
predefined function of one variable ( <code><a href="../reference/stepfun.html">?stepfun</a></code>, <code><a href="../reference/linfun.html">?linfun</a></code>, <code><a href="../reference/gompertz.html">?gompertz</a></code>,
<code><a href="../reference/weibull.html">?weibull</a></code>, <code><a href="../reference/piecewise_x.html">?piecewise_x</a></code>), or also
piecewise functions of two variables (<code><a href="../reference/piecewise_xy.html">?piecewise_xy</a></code>). We refer to the for more details on parameters types.
The parameters’ name can be used in the event and intensity definitions.
These names are fixed and cannot be modified after the compilation of the model, whereas the values of parameters can be modified from a simulation to another.</p>
<div class="section level4" number="2.3.1">
<h4 id="intensities">
<span class="header-section-number">2.3.1</span> Intensities<a class="anchor" aria-label="anchor" href="#intensities"></a>
</h4>
<p>Following the description of events intensities given in Section <a href="#Eventintensityth">1.3</a>, the intensity of an event <span class="math inline">\(e\)</span> belong to one of the following three classes: individual intensities without interaction between individuals (<span class="math inline">\(e\in \mathcal{E}\)</span>), corresponding to <a href="#eq:intensityNointeraction">(1.1)</a>, individual intensities with interaction (<span class="math inline">\(e\in \mathcal{E}_W\)</span>), corresponding to events <a href="#eq:intensityInteraction">(1.2)</a>, and (homogeneous or inhomogeneous) Poisson intensities (<span class="math inline">\(e\in \mathcal{P}\)</span>) <span class="math inline">\((\mu^e_t)_{t\geq 0}\)</span>.</p>
<p><strong>Event creation with individual intensity</strong> An event <span class="math inline">\(e\in \mathcal{E}\)</span> has an intensity of the form <span class="math inline">\(\lambda^e(t, I)\)</span>
which depends only on the individual <span class="math inline">\(I\)</span> and
time <span class="math inline">\(t\)</span>. Events with such intensity are created using the function</p>
<pre><code><span><span class="fu"><a href="../reference/mk_event_individual.html">mk_event_individual</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"TYPE"</span>,</span>
<span>                    name <span class="op">=</span> <span class="st">"NAME"</span>,</span>
<span>                    intensity_code <span class="op">=</span> <span class="st">"INTENSITY"</span>, <span class="va">...</span><span class="op">)</span></span></code></pre>
<p>The <code>intensity_code</code> argument is a character string containing
few lines of <code>C++</code> code describing the intensity function <span class="math inline">\(\lambda^e(t, I)\)</span>.
The intensity value has to be stored in a variable called
<code>result</code> and the
variables available (in addition to the model paramaters defined by the user) for the intensity code are given in the table below.</p>
<p><strong>Examples</strong></p>
<ol style="list-style-type: decimal">
<li>The intensity code below</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">death_intensity</span><span class="op">&lt;-</span> <span class="st">"if (I.male)</span></span>
<span><span class="st">                       result = alpha_1*exp(beta_1*age(I, t));</span></span>
<span><span class="st">                   else</span></span>
<span><span class="st">                       result = alpha_2*exp(beta_2*age(I,t));"</span></span></code></pre></div>
<p>corresponds to a death intensity equal to <span class="math inline">\(d_1(a) = \alpha_1 \exp(\beta_1 a)\)</span> for males and <span class="math inline">\(d_2(a) = \alpha_2 \exp(\beta_2 a)\)</span> for females. In this case, the intensity function depends on the individuals’ age, gender, and on the model parameters <span class="math inline">\(\alpha = (\alpha_1, \alpha_2)\)</span> and <span class="math inline">\(\beta = (\beta_1, \beta_2)\)</span>.</p>
<ol start="2" style="list-style-type: decimal">
<li>This example creates a death event with intensity depending on age and time, equal to
<span class="math display">\[\begin{equation*}
d(t,a) = 0.1\exp(0.005a) 1_{\{0\leq t &lt;5\}} + 0.08\exp(0.005a) 1_{\{5\leq t\}}
\end{equation*}\]</span>
</li>
</ol>
<p>This is done by creating the death function <span class="math inline">\(d\)</span> using the predefined package functions <code><a href="../reference/piecewise_xy.html">?piecewise_xy</a></code> and <code><a href="../reference/gompertz.html">?gompertz</a></code>. The function is then recorded as a model parameter and used in the argument <code>intensity_code</code> of <code><a href="../reference/mk_event_individual.html">?mk_event_individual</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_dep_function</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/piecewise_xy.html">piecewise_xy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>                                  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/gompertz.html">gompertz</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="fl">0.005</span><span class="op">)</span>,</span>
<span>                                       <span class="fu"><a href="../reference/gompertz.html">gompertz</a></span><span class="op">(</span><span class="fl">0.08</span>,<span class="fl">0.005</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">time_dep_function</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">65</span><span class="op">)</span> <span class="co"># death intensity at time 0 and age 65.</span></span>
<span><span class="co">## [1] 0.1384031</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"death_function"</span><span class="op">=</span> <span class="va">time_dep_function</span><span class="op">)</span></span>
<span></span>
<span><span class="va">death_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_event_individual.html">mk_event_individual</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"death"</span>,</span>
<span>                    intensity_code <span class="op">=</span> <span class="st">"result=time_dep_intensity(t,age(I,t));"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Event creation with interaction intensity</strong> An event <span class="math inline">\(e\in \mathcal{E}_W\)</span> is an event
which occurs to an individual at a frequency which is the result of
interactions with other members of the population (see Equation <a href="#eq:intensityInteraction">(1.2)</a>), and which can be written as <span class="math inline">\(\lambda^e_t(I, Z_t)=\sum_{J\in Z_t} W^e(t, I, J)\)</span> where <span class="math inline">\(W^e(t, I, J)\)</span> is the intensity of the interaction between individual <span class="math inline">\(I\)</span> and individual <span class="math inline">\(J\)</span>.</p>
<p>An event <span class="math inline">\(e\in \mathcal{E}_W\)</span> with such intensity is created by
calling the function</p>
<pre><code><span><span class="fu"><a href="../reference/mk_event_interaction.html">mk_event_interaction</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"TYPE"</span>,</span>
<span>                     name <span class="op">=</span> <span class="st">"NAME"</span>,</span>
<span>                     interaction_code <span class="op">=</span> <span class="st">"INTERACTION_CODE"</span>,</span>
<span>                     interaction_type <span class="op">=</span> <span class="st">"random"</span>, <span class="va">...</span><span class="op">)</span></span></code></pre>
<p>The <code>interaction_code</code> argument contains few lines of <code>C++</code> code
describing the interaction function <span class="math inline">\(W^e(t, I, J)\)</span>. The interaction function
value has to be stored in a variable called <code>result</code> and the
available variables for the intensity code are given in the table below.</p>
<p>For example, if we set</p>
<pre><code><span><span class="va">death_interaction_code</span> <span class="op">&lt;-</span> <span class="st">"result = max(J.size -I.size,0);"</span></span></code></pre>
<p>the death intensity of an individual <code>I</code> is
the result of the competition between individuals, depending on a
characteristic named <code>size</code>.</p>
<p>The argument <code>interaction_type</code>, set by default at
<code>random</code>, is an algorithm choice for simulating the model. When
<code>interaction_type=full</code>, the intensity is computed according to <a href="#eq:intensityInteraction">(1.2)</a>, which can be costly for large populations. One way to avoid this summation, is to set the <code>interaction_type</code> to <code>random</code>. This corresponds to replace the summation by an evaluation of the interaction function <span class="math inline">\(W^e\)</span> using an individual <span class="math inline">\(J\)</span> drawn uniformly from the population.
In most cases, the <code>random</code> algorithm is much faster than the
<code>full</code> algorithm, as we illustrate for instance in the <code><a href="../articles/IBMPopSim_interaction.html">vignette('IBMPopSim_interaction')</a></code>,
where we observe the gain of a factor of 20 between the two algorithms, on a set of standard parameters.
This allows in particular to explore parameter sets that give larger population sizes, without reaching computation times that explode.</p>
<p>Note that events with individual intensities are also much faster to
simulate since they only require to observe <em>one</em> individual to be
computed.</p>
<table class="table">
<caption>C++ variables available for intensity code</caption>
<thead><tr class="header">
<th align="left">Variable</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>I</code></td>
<td align="left">Current individual</td>
</tr>
<tr class="even">
<td align="left"><code>J</code></td>
<td align="left">Another individual in the population (only for interaction)</td>
</tr>
<tr class="odd">
<td align="left"><code>t</code></td>
<td align="left">Current time</td>
</tr>
<tr class="even">
<td align="left">Model parameters</td>
<td align="left">Depends on the model</td>
</tr>
</tbody>
</table>
<p><strong>Events creation with Poisson and Inhomogeneous Poisson
intensity</strong> For events <span class="math inline">\(e\in\mathcal{P}\)</span> with an intensity <span class="math inline">\(\mu^e(t)\)</span> which does not
depend on the population, the event intensity is of class <code>inhomogeneous_poisson</code> or <code>poisson</code>
depending on whether or not the intensity depends on time (in the second case the intensity is constant).</p>
<p>For Poisson (constant) intensities the events are created with the
function</p>
<pre><code><span><span class="fu"><a href="../reference/mk_event_poisson.html">mk_event_poisson</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"TYPE"</span>,</span>
<span>                 name <span class="op">=</span> <span class="st">"NAME"</span>,</span>
<span>                 intensity <span class="op">=</span> <span class="st">"CONSTANT"</span>, <span class="va">...</span><span class="op">)</span></span></code></pre>
<p>The following example creates a death event, where individuals die
at a constant intensity <code>lambda</code> (which has to be in the list of
model parameters).</p>
<pre><code><span><span class="fu"><a href="../reference/mk_event_poisson.html">mk_event_poisson</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"death"</span>,</span>
<span>                 intensity <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span></code></pre>
<p>When the intensity depends on
time (but not on the population), the event can be created similarly by
using the function</p>
<pre><code>mk_event_inhomogeneous_poisson(type = "TYPE",
                               name = "NAME"
                               intensity_code = "INTENSITY", ...)</code></pre>
<p>The following example creates the same death event than before, but now individuals die at the rate <span class="math inline">\(\lambda(1+ \cos(t))\)</span>.</p>
<pre><code><span><span class="fu"><a href="../reference/mk_event_inhomogeneous_poisson.html">mk_event_inhomogeneous_poisson</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"death"</span>,</span>
<span>                               intensity_code <span class="op">=</span> <span class="st">"result = lambda*(1+cos(t));"</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level4" number="2.3.2">
<h4 id="sub_par::event-kernel-code">
<span class="header-section-number">2.3.2</span> Event kernel code<a class="anchor" aria-label="anchor" href="#sub_par::event-kernel-code"></a>
</h4>
<p>When an event occurs, the model should specify how the event modify the population. This behavior is described in the <code>kernel_code</code> parameter of the <code>mk_event_CLASS(type = "TYPE", name ="NAME", ...)</code> function. The <code>kernel_code</code> is <code>NULL</code> by default and doesn’t have to be specified for death, exit events and birth events, but <strong>mandatory for entry and swap events</strong>. Recall that the <code>kernel_code</code> argument is a string composed of a few lines of <code>C++</code> code, characterizing the individual characteristics following the event. The table at the end of the section summarizes the list of available variables that can be used in the <code>kernel_code</code>.</p>
<ol style="list-style-type: decimal">
<li><p><strong>Death event</strong> If the user defines a <strong>death event</strong>, the death date of the current individual <code>I</code> is set to the current time <code>t</code>.</p></li>
<li><p><strong>Exit event</strong> When an individual <code>I</code> exits the population, <code>I.out</code> is set to <code>TRUE</code> and his exit time is recorded as a “death” date.</p></li>
<li><p><strong>Birth event</strong> The default generated event kernel is that an individual <code>I</code> gives birth to a new individual <code>newI</code> of age 0 at the current time <code>t</code>, with same characteristics than the parent <code>I</code>. If no kernel is specified, the default generated C++ code for a birth event is:</p></li>
</ol>
<pre><code>individual newI = I;
newI.birth_date = t;
pop.add(newI);</code></pre>
<p>The user can modify the birth kernel, by specify the argument <code>kernel_code</code> of <code>mk_event_CLASS</code>. In this case, the generated code is</p>
<pre><code>individual newI = I;
newI.birth_date = t;
_KERNEL_CODE_
pop.add(newI);</code></pre>
<p>where <code>_KERNEL_CODE_</code> is replaced by the content of the <code>kernel_code</code> argument. For instance, in a population where individuals are characterized by their gender, the kernel code</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">birth_kernel_code</span> <span class="op">&lt;-</span> <span class="st">"newI.male = (CUnif(0, 1) &lt; p_male);"</span></span></code></pre></div>
<p>creates new individuals which are males with probability <code>p_male</code>, or females otherwise. Here, <code>p_male</code> should be included in the list of model parameters.</p>
<ol start="4" style="list-style-type: decimal">
<li>
<strong>Entry event</strong> When an individual <code>I</code> enters the population, <code>I.entry</code> is set as the date at which the individual enters the population. When an entry occurs the individual entering the population is not of age <span class="math inline">\(0\)</span>. In this case, the user must specify the <code>kernel_code</code> argument indicating how the age and characteristics of the new individual are chosen. For instance,</li>
</ol>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mk_event_poisson.html">mk_event_poisson</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"entry"</span>, name <span class="op">=</span> <span class="st">"ev_example"</span>, intensity <span class="op">=</span> <span class="st">"lambda"</span>,</span>
<span>                 kernel_code <span class="op">=</span> <span class="st">"double a_I= max(CNorm(20,2),0);</span></span>
<span><span class="st">                                newI.set_age(a_I,t);"</span><span class="op">)</span></span></code></pre></div>
<p>creates an event of type Entry, named <code>ev_example</code>, where individuals enter the population at a constant intensity <code>lambda</code> (which has to be in the list of model parameters). When an individual <code>newI</code> enters the population at time <code>t</code>, his age is chosen as a normally distributed random variable, with mean 20 and variance 4, using the function <code>CNorm()</code> (see <code><a href="../articles/IBMPopSim_cpp.html">vignette('IBMPopSim_cpp')</a></code>).</p>
<table class="table">
<caption>C++ variables available for events kernel code</caption>
<thead><tr class="header">
<th align="left">Variable</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>I</code></td>
<td align="left">Current individual</td>
</tr>
<tr class="even">
<td align="left"><code>t</code></td>
<td align="left">Current time</td>
</tr>
<tr class="odd">
<td align="left"><code>pop</code></td>
<td align="left">Current population (vector)</td>
</tr>
<tr class="even">
<td align="left"><code>newI</code></td>
<td align="left">New individual. By default for birth events <code>newI = I</code> with <code>newI.birth = t</code>
</td>
</tr>
<tr class="odd">
<td align="left">Model parameters</td>
<td align="left">Depends on the model</td>
</tr>
</tbody>
</table>
<p>When there are several entry events, the user can identify which events generated the entry of an individual by adding a characteristic to the population recording the event name/id when it occurs. The same holds for the other types of events. See e.g. <code><a href="../articles/IBMPopSim_human_pop.html">vignette('IBMPopSim_human_pop')</a></code> for an example with different death events.</p>
</div>
</div>
<div class="section level3" number="2.4">
<h3 id="Modelcreation">
<span class="header-section-number">2.4</span> Model creation<a class="anchor" aria-label="anchor" href="#Modelcreation"></a>
</h3>
<p>Once the population, the events, and model parameters are defined, the IBM model is created using the function
<code><a href="../reference/mk_model.html">?mk_model</a></code>.</p>
<pre><code><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_model.html">mk_model</a></span><span class="op">(</span>characteristics <span class="op">=</span> <span class="fu"><a href="../reference/get_characteristics.html">get_characteristics</a></span><span class="op">(</span><span class="va">pop_init</span><span class="op">)</span>,</span>
<span>                  event <span class="op">=</span> <span class="va">events_list</span>,</span>
<span>                  parameters <span class="op">=</span> <span class="va">model_params</span><span class="op">)</span></span></code></pre>
<p>During this step which can take a few seconds, the model is created and
compiled using the Rcpp package. One of the advantages of the model
structure in IBMPopSim is that the model depends only on the population
characteristics’ and parameters names and types, rather than their
values. This means that once the model has been created, various
simulations can be done with different initial populations and
parameters values.</p>
<p><strong>Example</strong> Here is an example of model with a population structured by age and gender, with birth and death events. The death intensity of an individual of age <span class="math inline">\(a\)</span> is
<span class="math display">\[d(a) = 0.008 \exp(0.02a),\]</span>
and females between 15 and 40 can give birth with birth intensity 0.05. The newborn is a male with probability <span class="math inline">\(p_{male}= 0.51\)</span>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"p_male"</span><span class="op">=</span> <span class="fl">0.51</span>,</span>
<span>               <span class="st">"birth_rate"</span> <span class="op">=</span> <span class="fu"><a href="../reference/stepfun.html">stepfun</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span>,<span class="fl">40</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.05</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               <span class="st">"death_rate"</span> <span class="op">=</span> <span class="fu"><a href="../reference/gompertz.html">gompertz</a></span><span class="op">(</span><span class="fl">0.008</span>,<span class="fl">0.02</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">death_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_event_individual.html">mk_event_individual</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"death"</span>, name<span class="op">=</span> <span class="st">"my_death_event"</span>,</span>
<span>                  intensity_code <span class="op">=</span> <span class="st">"result = death_rate(age(I,t));"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">birth_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_event_individual.html">mk_event_individual</a></span><span class="op">(</span> type <span class="op">=</span> <span class="st">"birth"</span>,</span>
<span>                  intensity_code <span class="op">=</span> <span class="st">"if (I.male)</span></span>
<span><span class="st">                                        result = 0;</span></span>
<span><span class="st">                                    else</span></span>
<span><span class="st">                                        result=birth_rate(age(I,t));"</span>,</span>
<span>                  kernel_code <span class="op">=</span> <span class="st">"newI.male = CUnif(0, 1) &lt; p_male;"</span><span class="op">)</span></span>
<span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="va">EW_pop_14</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_model.html">mk_model</a></span><span class="op">(</span>characteristics <span class="op">=</span> <span class="fu"><a href="../reference/get_characteristics.html">get_characteristics</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>                  events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">death_event</span>,<span class="va">birth_event</span><span class="op">)</span>,</span>
<span>                  parameters <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summary(model)</span></span></code></pre></div>
</div>
<div class="section level3" number="2.5">
<h3 id="simulation">
<span class="header-section-number">2.5</span> Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h3>
<p>Once the model has been created, the random evolution of the population can be simulated over a period of time <span class="math inline">\([0,T]\)</span> by calling the function <code>popsim</code>:</p>
<pre><code><span><span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">pop_init</span>, <span class="va">events_bounds</span>, <span class="va">parameters</span>, age_max<span class="op">=</span><span class="cn">Inf</span>, <span class="va">time</span>,<span class="va">...</span><span class="op">)</span></span></code></pre>
<p>where <code>model</code> is the model created in the previous step, <code>pop_init</code> is the initial population, <code>events_bounds</code> the event bounds, <code>parameters</code> is the list of parameters values, <code>age_max</code> is
the maximum age of individuals in the population (set by default to <code>Inf</code>) and <code>time</code> is the final simulation time <span class="math inline">\(T\)</span> or a vector of times <span class="math inline">\((t_1, \dots ,t_n)\)</span>.</p>
<p>The IBM simulation algorithm for simulating random times is fully described in <span class="citation">(Giorgi, Kaakai, and Lemaire 2023)</span>.</p>
<div class="section level4" number="2.5.1">
<h4 id="events-bounds">
<span class="header-section-number">2.5.1</span> Events bounds<a class="anchor" aria-label="anchor" href="#events-bounds"></a>
</h4>
<p>Since the IBM simulation algorithm is based on an acceptance-rejection method for simulating random times, the user has to specify bounds for the intensity (or interaction) functions of each event (see assumptions <a href="#eq:boundlambda">(1.3)</a> and <a href="#eq:boundW">(1.4)</a>). These bounds should be stored in a named vector, where for event <span class="math inline">\(e\)</span>, the name corresponding to the event bound <span class="math inline">\(\bar{\mu}^e\)</span>, <span class="math inline">\(\bar{\lambda}^e\)</span> or <span class="math inline">\(\bar{W}^e\)</span> is the event <code>name</code> defined during the event creation step.</p>
<p><strong>Example</strong> In the model example built in the previous section, the birth intensity of an individual of age <span class="math inline">\(a\)</span> is <span class="math inline">\(0\)</span> if he is a male, and
<span class="math display">\[ b(a) = 0.005  \mathbf{1}_{[15,40]},\]</span>
if the individual is a female. Thus, the intensity bound for birth events is <span class="math inline">\(\bar\lambda_b = 0.005\)</span>.</p>
<p>Since the death intensity function is not bounded, the user will have to specify a maximum age <span class="math inline">\(a_{max}\)</span> in <code>popsim</code> (all individuals above <span class="math inline">\(a_{max}\)</span> die automatically). Then, the bound for death events is</p>
<p><span class="math display">\[ \bar \lambda_d = 0.008\exp(0.02 a_{max}).\]</span></p>
<p>In our example, the death event has been named <code>"my_death_event"</code>. No name has been specified for the birth event which thus has the default name <code>"birth"</code>. Then,</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a_max</span> <span class="op">&lt;-</span> <span class="fl">120</span> <span class="co"># maximum age</span></span>
<span><span class="va">events_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"my_death_event"</span> <span class="op">=</span> <span class="fl">0.008</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">0.02</span><span class="op">*</span><span class="va">a_max</span><span class="op">)</span>,</span>
<span>                   <span class="st">"birth"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">birth_rate</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note that the <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">?max</a></code> operator has been overloaded for some predefined functions of the package such as <code><a href="../reference/stepfun.html">?stepfun</a></code>.</p>
</div>
<div class="section level4" number="2.5.2">
<h4 id="Simulation1">
<span class="header-section-number">2.5.2</span> Simulation<a class="anchor" aria-label="anchor" href="#Simulation1"></a>
</h4>
<p>Once the model and events bounds have been defined, a random trajectory of the population can be simulated by calling</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">pop</span>, <span class="va">events_bounds</span>, <span class="va">params</span>,</span>
<span>                  age_max <span class="op">=</span> <span class="va">a_max</span>, time <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p><code>sim_out</code> is a list composed of</p>
<ul>
<li>A list <code>arguments</code> of the simulation inputs, including the initial population, parameters and event bounds.</li>
<li>A named numeric vector <code>logs</code> of variables related to the simulation algorithm.</li>
<li>The simulation output called <code>population</code>.</li>
</ul>
<p>When there are no swap events (individuals don’t change of characteristics), the evolution of the population over the period <span class="math inline">\([0,30]\)</span> is recorded in a <code>population</code> object called <code>sim_out$population</code>.
Each line of <code>sim_out$population</code> contains the information of an individual who lived in the population over the period <span class="math inline">\([0,30]\)</span>. This includes individuals who were initially in <code>pop</code>, as well as individuals who were born or entered the population.</p>
<p>The following Table <!--\@ref(tab:logs)--> describes the elements of the vector <code>sim_out$logs</code>containing information on simulation algorithm:</p>
<table class="table">
<caption>Logs parameters</caption>
<colgroup>
<col width="23%">
<col width="76%">
</colgroup>
<thead><tr class="header">
<th align="left">Elements</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code>proposed_events</code></td>
<td align="left">Number of candidate event times proposed during the simulation</td>
</tr>
<tr class="even">
<td align="left"><code>effective_events</code></td>
<td align="left">Number of events which occured during the simulation</td>
</tr>
<tr class="odd">
<td align="left"><code>cleanall_count</code></td>
<td align="left">Number of population cleans</td>
</tr>
<tr class="even">
<td align="left"><code>duration_ns</code></td>
<td align="left">Simulation time</td>
</tr>
</tbody>
</table>
<p>For instance, the acceptance rate in the toy model is</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_out</span><span class="op">$</span><span class="va">logs</span><span class="op">[</span><span class="st">'effective_events'</span><span class="op">]</span><span class="op">/</span><span class="va">sim_out</span><span class="op">$</span><span class="va">logs</span><span class="op">[</span><span class="st">'proposed_events'</span><span class="op">]</span></span>
<span><span class="co">## effective_events </span></span>
<span><span class="co">##        0.2183868</span></span></code></pre></div>
<p><strong>Optional parameters</strong> If there are <strong>no interactions</strong> between individuals, i.e. if there
are no events with intensity of class <code>interaction</code>, then the
simulation can be parallelized easily by setting the optional parameter
<code>multithreading</code> (<code>FALSE</code> by default) to <code>TRUE</code>.
By default, the number of threads is the number of concurrent threads
supported by the available hardware implementation. The number of threads
can be set manually with the optional argument <code>num_threads</code>.
By default, when the proportion of dead individuals in the population exceeds <span class="math inline">\(10\%\)</span>, the dead individuals are removed from the population. The user can modify this ratio using the optional argument <code>clean_ratio</code>, or by removing dead individuals from the population with a certain frequency, given by the <code>clean_step</code> argument. Finally, the user can also define the seed of the random number generator stored in the argument <code>seed</code>.</p>
<p><strong>Parameters modification and event removal</strong> As explained in Section <a href="#Modelcreation">2.4</a> the structure of the compiled model allows the parameters’ values to be changed without recompiling the model. For instance, the parameter of the Gompertz death function can be modified to study the impact of an increase in mortality.
Before running the simulation, the events bounds should be updated accordingly accordingly. An event can also be removed by setting the corresponding event bound to 0.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span><span class="op">$</span><span class="va">death_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gompertz.html">gompertz</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="fl">0.02</span><span class="op">)</span> <span class="co"># New death rate</span></span>
<span></span>
<span><span class="va">events_bounds</span><span class="op">[</span><span class="st">"my_death_event"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.01</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">0.02</span><span class="op">*</span><span class="va">a_max</span><span class="op">)</span> <span class="co"># Death event bound update</span></span>
<span></span>
<span><span class="va">new_sim_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">pop</span>, <span class="va">events_bounds</span>,</span>
<span>                      <span class="va">params</span>, age_max <span class="op">=</span> <span class="va">a_max</span>, time <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="co"># Population simulation</span></span></code></pre></div>
</div>
<div class="section level4" number="2.5.3">
<h4 id="outputs">
<span class="header-section-number">2.5.3</span> Outputs<a class="anchor" aria-label="anchor" href="#outputs"></a>
</h4>
<p>Base functions to study the simulation outputs are provided in the package. For instance, the population age pyramid can computed at a give time (resp. at multiple dates) with the function <code><a href="../reference/age_pyramid.html">?age_pyramid</a></code> (resp. <code><a href="../reference/age_pyramids.html">?age_pyramids</a></code>). We refer to the other vignettes for more details on age pyramids computation and visualization.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop_out</span> <span class="op">&lt;-</span> <span class="va">sim_out</span><span class="op">$</span><span class="va">population</span></span>
<span></span>
<span><span class="co"># Population age-pyramid at time 30:</span></span>
<span><span class="va">pyr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/age_pyramid.html">age_pyramid</a></span><span class="op">(</span><span class="va">pop_out</span>, ages <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="va">a_max</span>, time <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pyr</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<p><img src="main_plot_30-1.png" width="70%" style="display: block; margin: auto;"></p>
</div>
<p>Mortality tables with compatibles with packages such as StMoMo can also be computed by with the functions <code><a href="../reference/death_table.html">?death_table</a></code> and <code><a href="../reference/exposure_table.html">?exposure_table</a></code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">female_pop</span> <span class="op">&lt;-</span> <span class="va">pop_out</span><span class="op">[</span><span class="va">pop_out</span><span class="op">$</span><span class="va">male</span><span class="op">==</span><span class="cn">FALSE</span>, <span class="op">]</span></span>
<span><span class="va">Dxt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/death_table.html">death_table</a></span><span class="op">(</span><span class="va">female_pop</span>, ages <span class="op">=</span> <span class="fl">85</span><span class="op">:</span><span class="fl">90</span>, period <span class="op">=</span> <span class="fl">20</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span>    <span class="co"># Death table</span></span>
<span><span class="va">Ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exposure_table.html">exposure_table</a></span><span class="op">(</span><span class="va">female_pop</span>, ages <span class="op">=</span> <span class="fl">85</span><span class="op">:</span><span class="fl">90</span>, period <span class="op">=</span> <span class="fl">20</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3" number="2.6">
<h3 id="simulationswap">
<span class="header-section-number">2.6</span> Simulation with swap events<a class="anchor" aria-label="anchor" href="#simulationswap"></a>
</h3>
<p>When there are swap events (individuals can change of characteristics), recording the dates of swap events and changes of characteristics following each swap event is a memory intensive and computationally costly process.
To maintain efficient simulations in the presence of swap events, we propose the following solution.</p>
<div class="section level4" number="2.6.1">
<h4 id="vector-of-times-in-popsim-">
<span class="header-section-number">2.6.1</span> Vector of times in <code>?popsim</code>.<a class="anchor" aria-label="anchor" href="#vector-of-times-in-popsim-"></a>
</h4>
<p>In order to record individuals’ characteristics at different dates, the argument <code>time</code> of <code><a href="../reference/popsim.html">?popsim</a></code> can be replaced vector of dates <span class="math inline">\((t_0,\dots, t_n)\)</span>. In this case, <code>popsim</code> returns in the object <code>population</code> a list of <span class="math inline">\(n\)</span> <code>population</code> representing the population at time <span class="math inline">\(t_1,\dots t_n\)</span>, simulated from the initial time <span class="math inline">\(t_0\)</span>.
For <span class="math inline">\(i=1\dots n\)</span>, the <span class="math inline">\(i\)</span>th data frame describes individuals who lived in the population during the period <span class="math inline">\([t_0,t_i]\)</span>, with their characteristics at time <span class="math inline">\(t_i\)</span>.</p>
<p><strong>Example</strong> We consider a population divided into two subgroups. Individuals can swap from subgroup 1 (resp. 2) to subgroup 2 (resp. 1) at rate 0.1 (resp. 0.3).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"birth"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1e5</span><span class="op">)</span>, <span class="st">"death"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="fl">1e5</span><span class="op">)</span>,</span>
<span>                  <span class="st">"sub_grp"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1e5</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> k12 <span class="op">=</span> <span class="fl">0.1</span>, k21<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="co">#Only swap events occur in the population</span></span>
<span><span class="va">swap_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_event_individual.html">mk_event_individual</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"swap"</span>,</span>
<span>                  intensity_code <span class="op">=</span> <span class="st">"if (I.sub_grp == 1) result = k12;</span></span>
<span><span class="st">                                    else result = k21;"</span>,</span>
<span>                  kernel_code <span class="op">=</span> <span class="st">"I.sub_grp = 3 - I.sub_grp;"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_swap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_model.html">mk_model</a></span><span class="op">(</span>characteristics <span class="op">=</span> <span class="fu"><a href="../reference/get_characteristics.html">get_characteristics</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>                       events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">swap_event</span><span class="op">)</span>,</span>
<span>                       parameters <span class="op">=</span> <span class="va">rates</span><span class="op">)</span></span>
<span><span class="co">## Warning in compatibility_chars_events(characteristics, events): The list of events contains a 'swap' event and there is no 'id' in the characteristics.</span></span>
<span><span class="co">## Add 'id' to the characteristics if tracking changes along time is desired.</span></span></code></pre></div>
<p>Then, the population is simulated from <span class="math inline">\(t_0=0\)</span> to <span class="math inline">\(t_n =20\)</span>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_vec</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">20</span></span>
<span><span class="va">sim_out</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span>model <span class="op">=</span><span class="va">model_swap</span>, initial_population<span class="op">=</span> <span class="va">pop</span>,</span>
<span>                 events_bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"swap"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">rates</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 parameters <span class="op">=</span>  <span class="va">rates</span>,</span>
<span>                 time <span class="op">=</span> <span class="va">time_vec</span>,</span>
<span>                 multithreading <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The model is an ergodic two states continuous time Markov chain with stationary distribution <span class="math inline">\((p_1,p_2)=(0,75,0.25)\)</span>. The figure below illustrates the convergence of the probability to be in subgroup 1 to <span class="math inline">\(p_1\)</span></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></span>
<span><span class="co"># Mean number of individuals in subgroup 1 at each time:</span></span>
<span><span class="va">p_1_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sim_out</span><span class="op">$</span><span class="va">population</span>, <span class="kw">function</span><span class="op">(</span><span class="va">pop_df</span><span class="op">)</span><span class="op">{</span></span>
<span>                      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pop_df</span>, <span class="va">sub_grp</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">pop_size</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in parse(text = input): &lt;text&gt;:2:0: unexpected end of input</span></span>
<span><span class="co">## 1: ggplot()+geom_line(aes(x=time_vec[-1],y=p_1_t)+xlab("Time")+ylab("Probability of subgroup 1")</span></span>
<span><span class="co">##    ^</span></span></code></pre>
<p>This example shows that IBMPopSim can also be used to simulated continuous time Markov Chain with finite state space.</p>
</div>
<div class="section level4" number="2.6.2">
<h4 id="individual-life-courses">
<span class="header-section-number">2.6.2</span> Individual life courses<a class="anchor" aria-label="anchor" href="#individual-life-courses"></a>
</h4>
<p>It is possible also to isolate the individuals’ life course, by adding an <code>id</code> column to the population, which can be done by setting <code>id=TRUE</code> in the population construction, or by calling the <code><a href="../reference/add_characteristic.html">?add_characteristic</a></code> function to an existing population, in order to identify each individual with a unique integer.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/population.html">population</a></span><span class="op">(</span><span class="va">pop</span>, id <span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">model_swap_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_model.html">mk_model</a></span><span class="op">(</span>characteristics <span class="op">=</span>  <span class="fu"><a href="../reference/get_characteristics.html">get_characteristics</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,</span>
<span>                          events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">swap_event</span><span class="op">)</span>,</span>
<span>                          parameters <span class="op">=</span> <span class="va">rates</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_out_id</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model_swap_id</span>,</span>
<span>                    initial_population <span class="op">=</span> <span class="va">pop</span>,</span>
<span>                    parameters <span class="op">=</span> <span class="va">rates</span>,</span>
<span>                    events_bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"swap"</span><span class="op">=</span><span class="fl">0.3</span><span class="op">)</span>,</span>
<span>                    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span>, by<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                    multithreading <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim_out_id</span><span class="op">$</span><span class="va">population</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">##   id birth death sub_grp</span></span>
<span><span class="co">## 1  1     0    NA       1</span></span>
<span><span class="co">## 2  9     0    NA       2</span></span>
<span><span class="co">## 3 17     0    NA       2</span></span>
<span><span class="co">## 4 25     0    NA       2</span></span>
<span><span class="co">## 5 33     0    NA       1</span></span>
<span><span class="co">## 6 41     0    NA       1</span></span></code></pre></div>
<p>These data frames can be merged into a single data frame summarizing the life course of each individual, by calling the function <code>merge_pop_withid</code>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop_list</span> <span class="op">&lt;-</span> <span class="va">sim_out_id</span><span class="op">$</span><span class="va">population</span></span>
<span><span class="va">pop_merge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_pop_withid.html">merge_pop_withid</a></span><span class="op">(</span><span class="va">pop_list</span>, chars_tracked<span class="op">=</span><span class="st">'sub_grp'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pop_merge</span><span class="op">)</span></span>
<span><span class="co">##      id birth death sub_grp_1 sub_grp_2 sub_grp_3 sub_grp_4 sub_grp_5</span></span>
<span><span class="co">## 1     1     0    NA         1         1         1         1         1</span></span>
<span><span class="co">## 2 32769     0    NA         2         1         1         1         1</span></span>
<span><span class="co">## 3 65537     0    NA         2         2         2         2         2</span></span>
<span><span class="co">## 4 98305     0    NA         2         1         2         2         1</span></span>
<span><span class="co">## 5 31074     0    NA         1         1         1         1         1</span></span>
<span><span class="co">## 6 63842     0    NA         1         1         1         1         2</span></span></code></pre></div>
<p>Each line of <code>pop_merge</code> corresponds to the life course of one individual. However, the population is only represented at time <span class="math inline">\(t=0,1..,5\)</span>, and this data frame doesn’t account for exact swap event times or multiple swap events that occurred between between two time steps.</p>
</div>
</div>
</div>
<div class="section level2" number="3">
<h2 id="references">
<span class="header-section-number">3</span> References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-boumezoued2016" class="csl-entry">
Boumezoued, Alexandre. 2016. <span>“Approches Micro-Macro Des Dynamiques de Populations h<span>é</span>t<span>é</span>rog<span>è</span>nes Structur<span>é</span>es Par <span class="nocase">â</span>ge. Application Aux Processus Auto-Excitants Et <span class="nocase">à</span> La d<span>é</span>mographie.”</span>
</div>
<div id="ref-MR2562651" class="csl-entry">
Ferrière, Régis, and Viet Chi Tran. 2009. <span>“Stochastic and Deterministic Models for Age-Structured Populations with Genetically Variable Traits.”</span> <em>ESAIM Proc. C<span>ANUM</span> 2008</em> 27 (4): 289–310.
</div>
<div id="ref-MELEARD2004" class="csl-entry">
Fournier, Nicolas, and Sylvie Méléard. 2004. <span>“<span class="nocase">A microscopic probabilistic description of a locally regulated population and macroscopic approximations</span>.”</span> <em>Annals of Applied Probability</em> 14 (4): 1880–1919.
</div>
<div id="ref-GioKaaLem2023" class="csl-entry">
Giorgi, Daphné, Sarah Kaakai, and Vincent Lemaire. 2023. <span>“Efficient Simulation of Individual-Based Population Models: The r Package IBMPopSim.”</span> <a href="https://arxiv.org/abs/2303.06183" class="external-link">https://arxiv.org/abs/2303.06183</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Daphné Giorgi, Sarah Kaakai, Vincent Lemaire.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
