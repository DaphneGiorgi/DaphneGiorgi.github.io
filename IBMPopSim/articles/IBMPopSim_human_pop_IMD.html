<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Human population with swap • IBMPopSim</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Human population with swap">
<meta property="og:description" content="IBMPopSim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">IBMPopSim</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/IBMPopSim.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/IBMPopSim_cpp.html">C++ essentials</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/IBMPopSim_human_pop.html">Human population</a>
    </li>
    <li>
      <a href="../articles/IBMPopSim_human_pop_IMD.html">Human population with swap</a>
    </li>
    <li>
      <a href="../articles/IBMPopSim_insurance_portfolio.html">Insurance portfolio</a>
    </li>
    <li>
      <a href="../articles/IBMPopSim_interaction.html">Population with genetically variable traits</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DaphneGiorgi/IBMPopSim/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Human population with swap</h1>
                        <h4 data-toc-skip class="author">Daphné Giorgi, Sarah Kaakai, Vincent Lemaire</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DaphneGiorgi/IBMPopSim/blob/HEAD/vignettes/IBMPopSim_human_pop_IMD.Rmd" class="external-link"><code>vignettes/IBMPopSim_human_pop_IMD.Rmd</code></a></small>
      <div class="hidden name"><code>IBMPopSim_human_pop_IMD.Rmd</code></div>

    </div>

    
    
<!-- #region -->
<p>This vignette provides an example of usage of the package IBMPopSim, for simulating an heterogeneous “human population” in which individuals can change of characteristics over their life course. As this a more advance example of IBM simulation with <code>IBMPopSim</code>, it is recommended to start by reading the package vignettes <code><a href="../articles/IBMPopSim.html">vignette('IBMPopSim')</a></code> and <code><a href="../articles/IBMPopSim_human_pop.html">vignette('IBMPopSim_human_pop')</a></code>.</p>
<p>The population is based on data from England and Wales (EW) population, and individuals are characterized by the so-called Index of Multiple Deprivation (IMD), a deprivation index based on the place of living ( see <a href="https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/464430/English_Index_of_Multiple_Deprivation_2015_-_Guidance.pdf" class="external-link">here</a> for more details).</p>
<p>A toy model is simulated, where the individuals’ demographic rates depend on their IMD. Due to internal migrations, individuals can change of IMD over their life course (swap events).</p>
<div class="section level2" number="1">
<h2 id="example-description">
<span class="header-section-number">1</span> Example description<a class="anchor" aria-label="anchor" href="#example-description"></a>
</h2>
<p>The population is structured by age, gender and IMD. The population is distributed into five IMD quintiles. Group 1 corresponds to the least deprived subpopulation, and group 5 to the most deprived subpopulation.</p>
<p>Death and birth intensities are constant over time, but depend on the individuals age, gender and IMD. For instance, individuals in group 5 have a higher death intensity than individuals in group 1.</p>
<p>Individuals inherit the same IMD than their parent at birth, but can change of IMD over time, due to internal migration. In this toy model, we assume than younger individuals around 20 are more likely to move to more a deprived neighborhood, while individuals in the age class 30-45 are more likely to move to a less deprived neighborhood.</p>
</div>
<div class="section level2" number="2">
<h2 id="population-creation">
<span class="header-section-number">2</span> Population creation<a class="anchor" aria-label="anchor" href="#population-creation"></a>
</h2>
<p>The initial population is a 100 000 individuals population sampled from England and Wales’ 2014 age pyramid, structured by single year of age, gender and IMD quintile (source: Office for National Statistics).
<!-- #endregion --></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">EW_popIMD_14</span><span class="op">)</span></span>
<span><span class="co">## List of 3</span></span>
<span><span class="co">##  $ age_pyramid:'data.frame': 1160 obs. of  4 variables:</span></span>
<span><span class="co">##   ..$ age  : Factor w/ 116 levels "0 - 1","1 - 2",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##   ..$ IMD  : int [1:1160] 1 2 3 4 5 1 2 3 4 5 ...</span></span>
<span><span class="co">##   ..$ male : logi [1:1160] FALSE FALSE FALSE FALSE FALSE TRUE ...</span></span>
<span><span class="co">##   ..$ value: num [1:1160] 49114 54293 61541 73289 85626 ...</span></span>
<span><span class="co">##  $ death_rates:List of 2</span></span>
<span><span class="co">##   ..$ male  :'data.frame':   455 obs. of  3 variables:</span></span>
<span><span class="co">##   .. ..$ age  : int [1:455] 0 1 2 3 4 5 6 7 8 9 ...</span></span>
<span><span class="co">##   .. ..$ IMD  : num [1:455] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##   .. ..$ value: num [1:455] 2.59e-03 3.13e-04 1.02e-04 1.65e-05 1.46e-04 ...</span></span>
<span><span class="co">##   ..$ female:'data.frame':   455 obs. of  3 variables:</span></span>
<span><span class="co">##   .. ..$ age  : int [1:455] 0 1 2 3 4 5 6 7 8 9 ...</span></span>
<span><span class="co">##   .. ..$ IMD  : num [1:455] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##   .. ..$ value: num [1:455] 2.87e-03 2.52e-04 1.43e-04 8.73e-05 1.20e-04 ...</span></span>
<span><span class="co">##  $ sample     :'data.frame': 100000 obs. of  4 variables:</span></span>
<span><span class="co">##   ..$ birth: num [1:100000] -0.0917 -0.6313 -0.5008 -0.4568 -0.6978 ...</span></span>
<span><span class="co">##   ..$ death: num [1:100000] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##   ..$ male : logi [1:100000] FALSE TRUE TRUE FALSE TRUE FALSE ...</span></span>
<span><span class="co">##   ..$ IMD  : int [1:100000] 5 2 5 4 3 4 2 1 5 4 ...</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">EW_popIMD_14</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span></span>
<span><span class="co">##         birth death  male IMD</span></span>
<span><span class="co">## 1 -0.09170591    NA FALSE   5</span></span>
<span><span class="co">## 2 -0.63126956    NA  TRUE   2</span></span>
<span><span class="co">## 3 -0.50078693    NA  TRUE   5</span></span>
<span><span class="co">## 4 -0.45684987    NA FALSE   4</span></span>
<span><span class="co">## 5 -0.69782311    NA  TRUE   3</span></span>
<span><span class="co">## 6 -0.04470658    NA FALSE   4</span></span></code></pre></div>
<!-- #region -->
</div>
<div class="section level2" number="3">
<h2 id="events-description">
<span class="header-section-number">3</span> Events description<a class="anchor" aria-label="anchor" href="#events-description"></a>
</h2>
<p>There are 3 possible types of events :</p>
<ul>
<li>Birth</li>
<li>Death</li>
<li>Swap (internal migrations)</li>
</ul>
<p>Each event is characterized by its intensity and its kernel, as follows.
<!-- #endregion --></p>
<div class="section level3" number="3.1">
<h3 id="death-events">
<span class="header-section-number">3.1</span> Death events<a class="anchor" aria-label="anchor" href="#death-events"></a>
</h3>
<p>For each gender <span class="math inline">\(\epsilon\)</span> and IMD subgroup <span class="math inline">\(i=1..5\)</span>, we define a step function</p>
<p><span class="math display">\[d_i^\epsilon (a), \quad a=0,..a_{max}\]</span></p>
<p>defining the death intensity of an individual of age <span class="math inline">\(a\)</span>, gender <span class="math inline">\(\epsilon\)</span> and subgroup <span class="math inline">\(i\)</span>.</p>
<div class="section level4" number="3.1.1">
<h4 id="parameters">
<span class="header-section-number">3.1.1</span> Parameters<a class="anchor" aria-label="anchor" href="#parameters"></a>
</h4>
<p>Death intensities are based on EW 2014 age specific death rates by gender and IMD (source: Office for National Statistics).</p>
<p>Death rates are lower in less deprived quintiles.</p>
<p><img src="hpIMD_death_rate-1.png" width="1050" style="display: block; margin: auto;"></p>
<p><strong>Step functions creation</strong></p>
<p>The death intensity functions for each IMD and gender are defined as parameters of the model, as two list of R step functions.</p>
<p>These parameters will be transformed during the model creation into a vector of C++ step functions (starting from index 0).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params_death</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">EW_popIMD_14</span><span class="op">$</span><span class="va">death_rates</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="st">"death_male"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="../reference/stepfun.html">stepfun</a></span><span class="op">(</span>x<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">male</span>, <span class="va">IMD</span><span class="op">==</span><span class="va">i</span><span class="op">)</span><span class="op">[</span>,<span class="st">"age"</span><span class="op">]</span>,</span>
<span>                        y<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">male</span>, <span class="va">IMD</span><span class="op">==</span><span class="va">i</span><span class="op">)</span><span class="op">[</span>,<span class="st">"value"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="st">"death_female"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="../reference/stepfun.html">stepfun</a></span><span class="op">(</span>x<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">female</span>, <span class="va">IMD</span><span class="op">==</span><span class="va">i</span><span class="op">)</span><span class="op">[</span>,<span class="st">"age"</span><span class="op">]</span>,</span>
<span>                        y<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">female</span>, <span class="va">IMD</span><span class="op">==</span><span class="va">i</span><span class="op">)</span><span class="op">[</span>,<span class="st">"value"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>C++ code chunk implementing the intensity of a death event:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intensity_code_death</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">    if (I.male)</span></span>
<span><span class="st">        result = death_male[(I.IMD-1)](age(I,t));</span></span>
<span><span class="st">    else</span></span>
<span><span class="st">        result = death_female[(I.IMD-1)](age(I,t));</span></span>
<span><span class="st">'</span></span></code></pre></div>
<p><strong>Creation of the event</strong></p>
<p>By default, the name of the event is “death”.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">death_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_event_individual.html">mk_event_individual</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="st">"death"</span>,</span>
<span>    intensity_code <span class="op">=</span> <span class="va">intensity_code_death</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3" number="3.2">
<h3 id="birth-events">
<span class="header-section-number">3.2</span> Birth events<a class="anchor" aria-label="anchor" href="#birth-events"></a>
</h3>
<p>In this toy model, only women give birth, at a Weibull shaped intensity <span class="math inline">\(b_i(a)\)</span> depending on their age <span class="math inline">\(a\)</span> and IMD subgroup <span class="math inline">\(i\)</span>,</p>
<p><span class="math display">\[b_i(a)=TFR_i\frac{\beta_i}{\alpha_i}(\frac{(a-\bar{a})}{\alpha_i})^{\beta_i-1}\exp((-\frac{a-\bar{a}}{\alpha_i})^{\beta_i}).\]</span></p>
<p>These functions can be implemented by using the <code>IBMPopSim</code> function <code>weibull(k,c)</code>, which creates an R function corresponding the Weibull density function with parameters <span class="math inline">\((k,c)\)</span>, and which is translated into a C++ function during the model creation.</p>
<p>By default, the newborn inherit the IMD of his parent.</p>
<div class="section level4" number="3.2.1">
<h4 id="parameters-1">
<span class="header-section-number">3.2.1</span> Parameters<a class="anchor" aria-label="anchor" href="#parameters-1"></a>
</h4>
<p>We consider that women in the IMD subgroup 1 and 2 (resp. 4 and 5) have the same birth intensity functions. The parameters for birth events are thus composed of 10 parameters:</p>
<ul>
<li><span class="math inline">\(\bar{a}\)</span></li>
<li><span class="math inline">\(\alpha=(\alpha_1,\alpha_2,\alpha_3)\)</span></li>
<li><span class="math inline">\(\beta=(\beta_1,\beta_2,\beta_3)\)</span></li>
<li>
<span class="math inline">\(TFR = (TFR_1,TFR_2, TFR_3)\)</span>.</li>
</ul>
<p>Example of parameters values are available in <code>toy_params$birth</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># birth_sex_ratio = 1.05</span></span>
<span><span class="va">params_birth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">toy_params</span><span class="op">$</span><span class="va">birth</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="st">"TFR_weights"</span> <span class="op">=</span> <span class="va">TFR_weights</span>,</span>
<span>        <span class="st">"a_mean"</span><span class="op">=</span> <span class="fl">15</span>,</span>
<span>        <span class="st">"birth"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            <span class="fu"><a href="../reference/weibull.html">weibull</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">alpha</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># Weibull functions creation</span></span>
<span>            <span class="fu"><a href="../reference/weibull.html">weibull</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">alpha</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="../reference/weibull.html">weibull</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">alpha</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="st">"p_male"</span> <span class="op">=</span> <span class="fl">0.51</span> <span class="co"># probability to give birth to a male</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="hpIMD_birth_intensities-1.png" width="1050" style="display: block; margin: auto;"></p>
</div>
<div class="section level4" number="3.2.2">
<h4 id="event-creation">
<span class="header-section-number">3.2.2</span> Event creation<a class="anchor" aria-label="anchor" href="#event-creation"></a>
</h4>
<p>C++ code implementing the intensity of a birth event. The lists <code>params_birth$birth</code> and <code>params_birth$TFR_weights</code> are then transformed into C++ vectors (index starting at 0).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">birth_intensity_code</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">    if (I.male) result = 0.;</span></span>
<span><span class="st">    else {</span></span>
<span><span class="st">        if (I.IMD &lt;= 2) result = TFR_weights[0] * birth[0](age(I,t)-a_mean);</span></span>
<span><span class="st">        if (I.IMD == 3) result = TFR_weights[1] * birth[1](age(I,t)-a_mean);</span></span>
<span><span class="st">        if (I.IMD &gt;= 4) result = TFR_weights[2] * birth[2](age(I,t)-a_mean);</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">'</span></span></code></pre></div>
<p>Birth event creation</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">birth_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_event_individual.html">mk_event_individual</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="st">"birth"</span>,</span>
<span>    intensity_code <span class="op">=</span> <span class="va">birth_intensity_code</span>,</span>
<span>    kernel_code <span class="op">=</span> <span class="st">"newI.male = CUnif(0, 1) &lt; p_male;"</span> <span class="co"># Choice of gender for newborn</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3" number="3.3">
<h3 id="swap-event">
<span class="header-section-number">3.3</span> Swap event<a class="anchor" aria-label="anchor" href="#swap-event"></a>
</h3>
<p>Individuals can move during their lifetime, and thus change of IMD subgroup (swap events).</p>
<p>We assume that an individual can change of IMD subgroup with an intensity depending on his age and IMD subgroup.</p>
<p>Young individuals in the age class <span class="math inline">\([15,30]\)</span> and in the less deprived IMD quintiles (1 and 2) can move to more deprived areas, for instance for studying. On the other hand, older individuals in the age class <span class="math inline">\([30,45]\)</span> and <span class="math inline">\([0,15]\)</span>, and in deprived areas can move to a less deprived area, modeling for instance family formation, moving out to less deprived areas.</p>
<p>Age-specific swap intensities are given by 5 step functions, one for each IMD subgroup. When a swap event occur, the new IMD subgroup of the individual is determined by a discrete random variable depending on his age.</p>
<div class="section level4" number="3.3.1">
<h4 id="parameters-2">
<span class="header-section-number">3.3.1</span> Parameters<a class="anchor" aria-label="anchor" href="#parameters-2"></a>
</h4>
<p>Example parameters values are given in <code>toy_params$swap</code>.</p>
<p>Swap intensity functions are saved as model parameters as a list of step functions, which will be transformed into a C++ vector of functions when the model is created.
The vectors of discrete probabilities determining the action of the event when a swap occur is saved in a matrix, which will be transformed into a Rcpp Armadillo matrix.</p>
<p>Note that data frame are not accepted as model parameters.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params_swap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">toy_params</span><span class="op">$</span><span class="va">swap</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="st">"swap_intensities"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">intensities</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">rates</span><span class="op">)</span> <span class="fu"><a href="../reference/stepfun.html">stepfun</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">ages</span>,</span>
<span>                                    y<span class="op">=</span><span class="va">rates</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        <span class="st">"swap_distribution"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">distribution</span><span class="op">)</span>,</span>
<span>        <span class="st">"swap_age_to_idx"</span> <span class="op">=</span> <span class="fu"><a href="../reference/stepfun.html">stepfun</a></span><span class="op">(</span><span class="va">ages</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">df_intensities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"age"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">15</span>,<span class="fl">30</span>,<span class="fl">45</span><span class="op">)</span>,<span class="va">toy_params</span><span class="op">$</span><span class="va">swap</span><span class="op">$</span><span class="va">intensities</span><span class="op">)</span></span></code></pre></div>
<p><img src="hpIMD_df-1.png" width="1050" style="display: block; margin: auto;"></p>
<p>C++ code of the intensity of a swap event, using the model parameters:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intensity_code_swap</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">    result = swap_intensities[I.IMD-1](age(I,t));</span></span>
<span><span class="st">'</span></span></code></pre></div>
<p>C++ <strong>kernel code</strong> of a swap event</p>
<p>If a swap event occurs, the new IMD subgroup of the individual is determined by a discrete random variables, with probability distribution given by a row a <code>params_swap$swap_distribution</code>, depending on his age.</p>
<p>For instance, an individual of age in <span class="math inline">\([0,15]\)</span> has a probability of 0.6 to move on IMD subgroup 1 and 0.4 to move to IMD subgroup 2.</p>
<p>Discrete random variables can be drawn in <code>IBMPopSim</code> by calling the function <code>Cdiscrete</code> in the kernel code, with an <code>Armadillo</code> vector or matrix (see Section 3 of <code><a href="../articles/IBMPopSim.html">vignette('IBMPopSim')</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params_swap</span><span class="op">$</span><span class="va">swap_distribution</span></span>
<span><span class="co">##      IMD1 IMD2 IMD3 IMD4 IMD5</span></span>
<span><span class="co">## [1,]  0.6  0.4  0.0  0.0  0.0</span></span>
<span><span class="co">## [2,]  0.0  0.0  0.4  0.3  0.3</span></span>
<span><span class="co">## [3,]  0.6  0.4  0.0  0.0  0.0</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kernel_code_swap</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">    int idx = swap_age_to_idx(age(I,t)); // variables must by typed in C++</span></span>
<span><span class="st">    I.IMD = CDiscrete(swap_distribution.begin_row(idx),</span></span>
<span><span class="st">                      swap_distribution.end_row(idx)) + 1;</span></span>
<span><span class="st">'</span></span></code></pre></div>
<p>Swap event creation:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">swap_event</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_event_individual.html">mk_event_individual</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="st">"swap"</span>,</span>
<span>    intensity_code <span class="op">=</span> <span class="va">intensity_code_swap</span>,</span>
<span>    kernel_code <span class="op">=</span> <span class="va">kernel_code_swap</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2" number="4">
<h2 id="model-creation-without-id">
<span class="header-section-number">4</span> Model creation (without id)<a class="anchor" aria-label="anchor" href="#model-creation-without-id"></a>
</h2>
<p>The model is created by calling the function <code><a href="../reference/mk_model.html">?mk_model</a></code> with as arguments:</p>
<ul>
<li>The individuals’ characteristics.</li>
<li>The events list.</li>
<li>The vector of model parameters (only parameters name and types are saved).</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">params_birth</span>, <span class="va">params_death</span>, <span class="va">params_swap</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_model.html">mk_model</a></span><span class="op">(</span></span>
<span>    characteristics <span class="op">=</span> <span class="fu"><a href="../reference/get_characteristics.html">get_characteristics</a></span><span class="op">(</span><span class="va">EW_popIMD_14</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>,</span>
<span>    events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">birth_event</span>, <span class="va">death_event</span>, <span class="va">swap_event</span><span class="op">)</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">## Events:</span></span>
<span><span class="co">## #1: individual event of type birth</span></span>
<span><span class="co">## #2: individual event of type death</span></span>
<span><span class="co">## #3: individual event of type swap</span></span>
<span><span class="co">## --------------------------------------- </span></span>
<span><span class="co">## Individual description:</span></span>
<span><span class="co">## names:  birth death male IMD </span></span>
<span><span class="co">## R types:  double double logical integer </span></span>
<span><span class="co">## C types:  double double bool int</span></span>
<span><span class="co">## --------------------------------------- </span></span>
<span><span class="co">## R parameters available in C++ code:</span></span>
<span><span class="co">## names:  TFR_weights a_mean birth p_male death_male death_female swap_intensities swap_distribution swap_age_to_idx </span></span>
<span><span class="co">## R types:  vector double list double list list list matrix closure </span></span>
<span><span class="co">## C types:  arma::vec double list_of_function_x double list_of_function_x list_of_function_x list_of_function_x arma::mat function_x</span></span></code></pre></div>
<!-- #region -->
</div>
<div class="section level2" number="5">
<h2 id="simulation">
<span class="header-section-number">5</span> Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h2>
<div class="section level3" number="5.1">
<h3 id="events-bounds">
<span class="header-section-number">5.1</span> Events bounds<a class="anchor" aria-label="anchor" href="#events-bounds"></a>
</h3>
<p>The first step before simulating the model is to compute bounds for each event intensity.
<!-- #endregion --></p>
<p><strong>Birth intensity bound</strong></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">E</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">birth_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">params</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">(</span></span>
<span>                      <span class="va">TFR_weights</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/optimize.html" class="external-link">optimize</a></span><span class="op">(</span>f<span class="op">=</span><span class="va">birth</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, interval<span class="op">=</span><span class="va">E</span>,</span>
<span>                        maximum<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">objective</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>                  <span class="op">)</span></span></code></pre></div>
<p><strong>Death intensity bound</strong></p>
<p>The operator <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">?max</a></code> has been overloaded in <code>IBMPopSim</code> and can be applied to step functions.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">death_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">death_male</span>, <span class="va">max</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">death_female</span>, <span class="va">max</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Swap intensity bound</strong></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">swap_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">params</span><span class="op">$</span><span class="va">swap_intensities</span>, <span class="va">max</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3" number="5.2">
<h3 id="simulation-1">
<span class="header-section-number">5.2</span> Simulation<a class="anchor" aria-label="anchor" href="#simulation-1"></a>
</h3>
<p>Recording all swap events is computationally expensive. To overcome this difficulty, the simulation in the presence of swap events returns a list of data frame, composed of a “picture” of the population at all times in the vector argument <code>time</code> of <code>popsim</code> (see <code><a href="../articles/IBMPopSim.html">vignette('IBMPopSim')</a></code> for more details).</p>
<p>The first component of the variable <code>t_sim</code> below is the initial time. The simulation returns <code>n-1</code> data frame representing the population at <span class="math inline">\(t\_sim[1],..,t\_sim[n]\)</span>. The data frame corresponding to time <span class="math inline">\(t\_sim[i]\)</span> is composed of all individuals who lived in the population before <span class="math inline">\(t\_sim[i]\)</span>, with their characteristics at time <span class="math inline">\(t\_sim[i]\)</span>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t_sim</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">50</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t_sim</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span><span class="va">model</span>,</span>
<span>    population <span class="op">=</span> <span class="va">EW_popIMD_14</span><span class="op">$</span><span class="va">sample</span>, <span class="co"># Initial population</span></span>
<span>    events_bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'birth'</span> <span class="op">=</span> <span class="va">birth_max</span>, <span class="st">'swap'</span> <span class="op">=</span> <span class="va">swap_max</span>, <span class="st">'death'</span> <span class="op">=</span> <span class="va">death_max</span><span class="op">)</span>,</span>
<span>            <span class="co"># Names corresponding to events name</span></span>
<span>    parameters <span class="op">=</span> <span class="va">params</span>,</span>
<span>    time <span class="op">=</span> <span class="va">t_sim</span>,</span>
<span>    multithreading<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># Set to T since there are no interactions</span></span>
<span>                <span class="op">)</span></span>
<span><span class="co">## Simulation on  [0, 1]  [1, 2]  [2, 3]  [3, 4]  [4, 5]  [5, 6]  [6, 7]  [7, 8]  [8, 9]  [9, 10]  [10, 11]  [11, 12]  [12, 13]  [13, 14]  [14, 15]  [15, 16]  [16, 17]  [17, 18]  [18, 19]  [19, 20]  [20, 21]  [21, 22]  [22, 23]  [23, 24]  [24, 25]  [25, 26]  [26, 27]  [27, 28]  [28, 29]  [29, 30]  [30, 31]  [31, 32]  [32, 33]  [33, 34]  [34, 35]  [35, 36]  [36, 37]  [37, 38]  [38, 39]  [39, 40]  [40, 41]  [41, 42]  [42, 43]  [43, 44]  [44, 45]  [45, 46]  [46, 47]  [47, 48]  [48, 49]  [49, 50]</span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="6">
<h2 id="outputs">
<span class="header-section-number">6</span> Outputs<a class="anchor" aria-label="anchor" href="#outputs"></a>
</h2>
<p>Swap events modify the population composition, by increasing the proportion of individuals in the less deprived subgroups, especially for younger age groups.</p>
<div class="section level3" number="6.1">
<h3 id="initial-and-final-age-pyramids-with-different-imd-subgroups">
<span class="header-section-number">6.1</span> Initial and final age pyramids with different IMD subgroups<a class="anchor" aria-label="anchor" href="#initial-and-final-age-pyramids-with-different-imd-subgroups"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pyr_init</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/age_pyramids.html">age_pyramids</a></span><span class="op">(</span><span class="va">EW_popIMD_14</span><span class="op">$</span><span class="va">sample</span>,time <span class="op">=</span> <span class="fl">0</span>, ages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">100</span>,<span class="fl">130</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pyr_init</span><span class="op">$</span><span class="va">group_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">pyr_init</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">male</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Males - IMD'</span>, <span class="va">IMD</span><span class="op">)</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Females - IMD'</span>, <span class="va">IMD</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Final age pyramid</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pops_out</span> <span class="op">&lt;-</span> <span class="va">sim_out</span><span class="op">$</span><span class="va">population</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pyr_IMD</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/age_pyramid.html">age_pyramid</a></span><span class="op">(</span><span class="va">pops_out</span><span class="op">[[</span><span class="fl">50</span><span class="op">]</span><span class="op">]</span>, time <span class="op">=</span> <span class="fl">50</span>,ages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">100</span>,<span class="fl">130</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pyr_IMD</span><span class="op">$</span><span class="va">group_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">pyr_IMD</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">male</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Males - IMD'</span>, <span class="va">IMD</span><span class="op">)</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Females - IMD'</span>, <span class="va">IMD</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/hcl_palettes.html" class="external-link">sequential_hcl</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">5</span>, palette <span class="op">=</span> <span class="st">"Magenta"</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://colorspace.R-Forge.R-project.org/reference/hcl_palettes.html" class="external-link">sequential_hcl</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">5</span>, palette <span class="op">=</span> <span class="st">"Teal"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">colors</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Females - IMD'</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'Males - IMD'</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_pyramid.html">plot_pyramid</a></span><span class="op">(</span><span class="va">pyr_init</span>,<span class="va">colors</span><span class="op">)</span></span></code></pre></div>
<p><img src="hpIMD_pyramids-1.png" width="1050" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_pyramid.html">plot_pyramid</a></span><span class="op">(</span><span class="va">pyr_IMD</span>,<span class="va">colors</span><span class="op">)</span></span></code></pre></div>
<p><img src="hpIMD_pyramids-2.png" width="1050" style="display: block; margin: auto;"></p>
<!--```{remark}-->
<p>The high number of individuals aged over 100 is due to the fact that mortality rates are assumed to be constant at ages over 90, which is of course not realistic for human populations (see <code><a href="../articles/IBMPopSim_human_pop.html">vignette('IBMPopSim_human_pop')</a></code>) for another choice of mortality rates.
<!--```--></p>
</div>
<div class="section level3" number="6.2">
<h3 id="evolution-of-population-composition-by-age-group">
<span class="header-section-number">6.2</span> Evolution of population composition by age group<a class="anchor" aria-label="anchor" href="#evolution-of-population-composition-by-age-group"></a>
</h3>
<p>The plots below illustrates the evolution of the female population composition for different age groups over time.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">30</span>,<span class="fl">95</span>,<span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">age_pyrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="../reference/age_pyramid.html">age_pyramid</a></span><span class="op">(</span><span class="va">pops_out</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,<span class="va">t_sim</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>,<span class="va">age_grp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">age_pyr_fem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">bind_rows</span><span class="op">(</span><span class="va">age_pyrs</span>,.id<span class="op">=</span><span class="st">"time"</span><span class="op">)</span>, <span class="va">male</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">compo_pop_fem</span> <span class="op">&lt;-</span> <span class="va">age_pyr_fem</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">group_by</span><span class="op">(</span><span class="va">age</span>,<span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">mutate</span><span class="op">(</span>composition <span class="op">=</span> <span class="va">value</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="hpIMD_compo_fem-1.png" width="1050" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2" number="7">
<h2 id="different-simulations-with-the-same-model">
<span class="header-section-number">7</span> Different simulations with the same model<a class="anchor" aria-label="anchor" href="#different-simulations-with-the-same-model"></a>
</h2>
<p>The model parameters and initial population can be modified without having to recompile the model.</p>
<p>In particular, events can be deactivated by setting the event bound to 0.</p>
<div class="section level3" number="7.1">
<h3 id="simulation-without-swap-events">
<span class="header-section-number">7.1</span> Simulation without swap events<a class="anchor" aria-label="anchor" href="#simulation-without-swap-events"></a>
</h3>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_out_noswp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span><span class="va">model</span>,</span>
<span>    population <span class="op">=</span> <span class="va">EW_popIMD_14</span><span class="op">$</span><span class="va">sample</span>,</span>
<span>    events_bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'birth'</span> <span class="op">=</span> <span class="va">birth_max</span>, <span class="st">'swap'</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">'death'</span> <span class="op">=</span> <span class="va">death_max</span><span class="op">)</span>,</span>
<span>            <span class="co"># Swap events deactivated</span></span>
<span>    parameters <span class="op">=</span> <span class="va">params</span>,</span>
<span>    time <span class="op">=</span> <span class="va">t_sim</span>,</span>
<span>    multithreading<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## [1] "event swap is deactivated"</span></span>
<span><span class="co">## Simulation on  [0, 1]  [1, 2]  [2, 3]  [3, 4]  [4, 5]  [5, 6]  [6, 7]  [7, 8]  [8, 9]  [9, 10]  [10, 11]  [11, 12]  [12, 13]  [13, 14]  [14, 15]  [15, 16]  [16, 17]  [17, 18]  [18, 19]  [19, 20]  [20, 21]  [21, 22]  [22, 23]  [23, 24]  [24, 25]  [25, 26]  [26, 27]  [27, 28]  [28, 29]  [29, 30]  [30, 31]  [31, 32]  [32, 33]  [33, 34]  [34, 35]  [35, 36]  [36, 37]  [37, 38]  [38, 39]  [39, 40]  [40, 41]  [41, 42]  [42, 43]  [43, 44]  [44, 45]  [45, 46]  [46, 47]  [47, 48]  [48, 49]  [49, 50]</span></span></code></pre></div>
<p><strong>Comparison of population evolution with and without swap events</strong></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_pyrs_nosw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="kw">function</span> <span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="../reference/age_pyramid.html">age_pyramid</a></span><span class="op">(</span><span class="va">sim_out_noswp</span><span class="op">$</span><span class="va">population</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                              <span class="va">t_sim</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>,<span class="va">age_grp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">compo_pop_fem_nosw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">bind_rows</span><span class="op">(</span><span class="va">age_pyrs_nosw</span>,.id<span class="op">=</span><span class="st">"time"</span><span class="op">)</span>, <span class="va">male</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>                <span class="fu">group_by</span><span class="op">(</span><span class="va">age</span>,<span class="va">time</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>perc<span class="op">=</span><span class="va">value</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="hpIMD_compo_fem2-1.png" width="1050" style="display: block; margin: auto;"><img src="hpIMD_compo_fem2-2.png" width="1050" style="display: block; margin: auto;"></p>
</div>
<div class="section level3" number="7.2">
<h3 id="simulation-of-individual-life-courses">
<span class="header-section-number">7.2</span> Simulation of individual life courses<a class="anchor" aria-label="anchor" href="#simulation-of-individual-life-courses"></a>
</h3>
<p>In the presence of swap events, individual trajectories can be isolated by attributing a unique id to each individuals in the population. This is done during the model creation step by setting the optional argument <code>with_id</code> to <code>TRUE</code>.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mk_model.html">mk_model</a></span><span class="op">(</span></span>
<span>    characteristics <span class="op">=</span> <span class="fu"><a href="../reference/get_characteristics.html">get_characteristics</a></span><span class="op">(</span><span class="va">EW_popIMD_14</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>,</span>
<span>    events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">birth_event</span>, <span class="va">death_event</span>, <span class="va">swap_event</span><span class="op">)</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">params</span>,</span>
<span>    with_id <span class="op">=</span> <span class="cn">TRUE</span> <span class="co"># Adds a characteristic called id, unique for each individuals.</span></span>
<span>                 <span class="op">)</span></span>
<span><span class="co">## [1] "add 'id' as individual attributes"</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_out_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/popsim.html">popsim</a></span><span class="op">(</span><span class="va">model_id</span>,</span>
<span>    population <span class="op">=</span> <span class="va">EW_popIMD_14</span><span class="op">$</span><span class="va">sample</span>,</span>
<span>    events_bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'birth'</span> <span class="op">=</span> <span class="va">birth_max</span>, <span class="st">'swap'</span> <span class="op">=</span> <span class="va">swap_max</span>, <span class="st">'death'</span> <span class="op">=</span> <span class="va">death_max</span><span class="op">)</span>,</span>
<span>    parameters <span class="op">=</span> <span class="va">params</span>,</span>
<span>    time <span class="op">=</span> <span class="va">t_sim</span>,</span>
<span>    multithreading<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## [1] "Add 'id' attributes to the population."</span></span>
<span><span class="co">## Simulation on  [0, 1]  [1, 2]  [2, 3]  [3, 4]  [4, 5]  [5, 6]  [6, 7]  [7, 8]  [8, 9]  [9, 10]  [10, 11]  [11, 12]  [12, 13]  [13, 14]  [14, 15]  [15, 16]  [16, 17]  [17, 18]  [18, 19]  [19, 20]  [20, 21]  [21, 22]  [22, 23]  [23, 24]  [24, 25]  [25, 26]  [26, 27]  [27, 28]  [28, 29]  [29, 30]  [30, 31]  [31, 32]  [32, 33]  [33, 34]  [34, 35]  [35, 36]  [36, 37]  [37, 38]  [38, 39]  [39, 40]  [40, 41]  [41, 42]  [42, 43]  [43, 44]  [44, 45]  [45, 46]  [46, 47]  [47, 48]  [48, 49]  [49, 50]</span></span></code></pre></div>
<p>When each individual has been attributed a unique id, a data frame summarizing each life course can be obtained from the simulation output <code>sim_out_id$population</code>(list of data frames) by calling the function <code>merge_pop_withid</code>.</p>
<p>Characteristics to be tracked over time must be specified in the argument <code>chars_tracked</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_pop_withid.html">merge_pop_withid</a></span><span class="op">(</span><span class="va">sim_out_id</span><span class="op">$</span><span class="va">population</span>, chars_tracked <span class="op">=</span> <span class="st">"IMD"</span><span class="op">)</span></span></code></pre></div>
<p><code>pop_id</code> is data frame in which each line corresponds to an individual and include his id, birth date, death date, gender and IMD subgroup at each discretization time (components of <span class="math inline">\(t_{sim}\)</span>).</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pop_id</span><span class="op">)</span></span>
<span><span class="co">##       id        birth death  male IMD_1 IMD_2 IMD_3 IMD_4 IMD_5 IMD_6 IMD_7 IMD_8 IMD_9 IMD_10 IMD_11 IMD_12</span></span>
<span><span class="co">## 1      1  -0.09170591    NA FALSE     5     5     5     5     5     5     5     5     5      5      5      5</span></span>
<span><span class="co">## 2  20501 -17.89396191    NA FALSE     5     4     1     5     3     1     3     2     5      3      4      2</span></span>
<span><span class="co">## 3  59811 -46.23905106    NA FALSE     1     2     2     5     2     4     5     4     5      1      4      5</span></span>
<span><span class="co">## 4 107435   5.13748862    NA FALSE    NA    NA    NA    NA    NA     1     2     5     1      1      4      3</span></span>
<span><span class="co">## 5  10865  -8.21259434    NA FALSE     5     5     5     1     3     1     1     2     4      2      2      4</span></span>
<span><span class="co">## 6 136812  29.07957063    NA  TRUE    NA    NA    NA    NA    NA    NA    NA    NA    NA     NA     NA     NA</span></span>
<span><span class="co">##   IMD_13 IMD_14 IMD_15 IMD_16 IMD_17 IMD_18 IMD_19 IMD_20 IMD_21 IMD_22 IMD_23 IMD_24 IMD_25 IMD_26 IMD_27 IMD_28</span></span>
<span><span class="co">## 1      5      5      5      5      5      5      5      5      5      5      5      5      5      5      5      5</span></span>
<span><span class="co">## 2      4      5      4      3      5      1      1      1      2      1      4      5      1      5      1      1</span></span>
<span><span class="co">## 3      2      5      5      2      2      2      3      3      4      1      4      5      4      4      2      1</span></span>
<span><span class="co">## 4      1      4      2      3      5      1      1      5      1      1      1      1      3      1      5      5</span></span>
<span><span class="co">## 5      1      3      1      3      5      5      3      1      3      1      2      4      5      2      3      2</span></span>
<span><span class="co">## 6     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA</span></span>
<span><span class="co">##   IMD_29 IMD_30 IMD_31 IMD_32 IMD_33 IMD_34 IMD_35 IMD_36 IMD_37 IMD_38 IMD_39 IMD_40 IMD_41 IMD_42 IMD_43 IMD_44</span></span>
<span><span class="co">## 1      5      5      5      5      5      5      5      5      5      5      5      5      5      5      5      5</span></span>
<span><span class="co">## 2      3      4      4      4      2      1      1      3      4      4      3      1      1      1      3      2</span></span>
<span><span class="co">## 3      1      4      5      5      2      4      2      1      2      1      1      5      2      5      2      1</span></span>
<span><span class="co">## 4      4      5      5      2      1      1      5      2      2      3      4      3      3      5      3      4</span></span>
<span><span class="co">## 5      5      2      4      2      1      5      3      2      1      4      4      4      4      2      1      3</span></span>
<span><span class="co">## 6     NA      4      1      3      2      5      5      1      1      2      3      5      4      5      3      1</span></span>
<span><span class="co">##   IMD_45 IMD_46 IMD_47 IMD_48 IMD_49 IMD_50</span></span>
<span><span class="co">## 1      5      5      5      5      5      5</span></span>
<span><span class="co">## 2      4      1      3      1      1      5</span></span>
<span><span class="co">## 3      4      2      3      1      1      2</span></span>
<span><span class="co">## 4      4      4      3      1      1      3</span></span>
<span><span class="co">## 5      2      4      1      3      1      2</span></span>
<span><span class="co">## 6      3      1      1      3      2      4</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Daphné Giorgi, Sarah Kaakai, Vincent Lemaire.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
